#!/bin/bash
m4 -DAPACHE_EVENT_START_SERVERS="{{$APACHE_EVENT_START_SERVERS}}" \
   -DAPACHE_EVENT_MIN_SPARE_THREADS="{{$APACHE_EVENT_MIN_SPARE_THREADS}}" \
   -DAPACHE_EVENT_MAX_SPARE_THREADS="{{$APACHE_EVENT_MAX_SPARE_THREADS}}" \
   -DAPACHE_EVENT_THREAD_LIMIT="{{$APACHE_EVENT_THREAD_LIMIT}}" \
   -DAPACHE_EVENT_THREADS_PER_CHILD="{{$APACHE_EVENT_THREADS_PER_CHILD}}" \
   -DAPACHE_EVENT_MAX_REQUEST_EVENTS="{{$APACHE_EVENT_MAX_REQUEST_EVENTS}}" \
   -DAPACHE_EVENT_MAX_CONNECTIONS_PER_CHILD="{{$APACHE_EVENT_MAX_CONNECTIONS_PER_CHILD}}" /etc/apache2/mods-available/mpm_event.conf.m4 > /etc/apache2/mods-available/mpm_event.conf

m4 -DAPACHE_SERVER_NAME="{{$APACHE_SERVER_NAME}}" /etc/apache2/conf-available/server-name.conf.m4 > /etc/apache2/conf-available/server-name.conf

m4  -DPHP_FPM_PM="{{$PHP_FPM_PM}}" \
    -DPHP_FPM_MAX_CHILDREN="{{$PHP_FPM_MAX_CHILDREN}}" \
    -DPHP_FPM_START_SERVERS="{{$PHP_FPM_START_SERVERS}}" \
    -DPHP_FPM_SPARE_SERVERS="{{$PHP_FPM_SPARE_SERVERS}}" \
    -DPHP_FPM_MAX_SPARE_SERVERS="{{$PHP_FPM_MAX_SPARE_SERVERS}}" \
    -DPHP_FPM_PROCESS_IDLE_TIMEOUT="{{$PHP_FPM_PROCESS_IDLE_TIMEOUT}}" \
    -DPHP_FPM_MAX_REQUESTS="{{$PHP_FPM_MAX_REQUESTS}}" /etc/php5/fpm/pool.d/www.conf.m4 > /etc/php5/fpm/pool.d/www.conf


service php7.0-fpm start

exec /usr/sbin/apache2 -D FOREGROUND $@
